"use client"

import { updateSearchEngine } from "@/app/new-tab/actions"
import { Button } from "@/components/ui/button"
import {
  ContextMenu,
  ContextMenuContent,
  ContextMenuRadioGroup,
  ContextMenuRadioItem,
  ContextMenuTrigger,
} from "@/components/ui/context-menu"
import { Input } from "@/components/ui/input"
import { Search } from "lucide-react"
import { type JSX, useState, useTransition } from "react"

type SearchBarProps = {
  initialEngine: string
}

const engines: Record<
  string,
  {
    name: string
    url: string
    Icon: (
      props: JSX.IntrinsicAttributes & { className: string }
    ) => JSX.Element
  }
> = {
  google: {
    name: "Google",
    url: "https://www.google.com/search",
    Icon: (props) => (
      <svg
        {...props}
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        fill="currentColor"
      >
        <path d="M21.35,11.1H12.18V13.83H18.69C18.36,17.64 15.19,19.27 12.19,19.27C8.36,19.27 5.03,16.2 5.03,12.3C5.03,8.4 8.36,5.33 12.19,5.33C14.04,5.33 15.3,6.14 16.1,6.92L18.27,4.79C16.63,3.27 14.57,2.3 12.19,2.3C6.92,2.3 2.73,6.63 2.73,12.3C2.73,17.97 6.92,22.3 12.19,22.3C17.6,22.3 21.54,18.42 21.54,12.51C21.54,11.97 21.45,11.53 21.35,11.1Z" />
      </svg>
    ),
  },
  duckduckgo: {
    name: "DuckDuckGo",
    url: "https://duckduckgo.com/",
    Icon: (props) => (
      <svg
        {...props}
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        fill="currentColor"
      >
        <path d="M 2 12 C 2 9.109375 2.945313 6.722656 4.832031 4.832031 C 6.722656 2.945313 9.109375 2 12 2 C 14.890625 2 17.277344 2.945313 19.167969 4.832031 C 21.054688 6.722656 22 9.109375 22 12 C 22 14.445313 21.308594 16.550781 19.921875 18.308594 C 18.539063 20.070313 16.65625 21.21875 14.277344 21.757813 C 14.15625 21.53125 13.933594 21.179688 13.601563 20.710938 C 13.273438 20.238281 13.042969 19.863281 12.90625 19.582031 C 13.765625 19.929688 14.34375 20.105469 14.640625 20.105469 C 14.855469 20.105469 14.964844 19.769531 14.964844 19.097656 C 14.964844 17.847656 14.851563 17.222656 14.621094 17.222656 C 14.285156 17.222656 13.632813 17.59375 12.664063 18.332031 C 12.664063 18.144531 12.5625 18.0625 12.363281 18.089844 L 12.261719 18.089844 C 11.914063 17.160156 11.738281 16.335938 11.738281 15.609375 C 11.738281 15.40625 11.757813 15.207031 11.796875 15.003906 C 13.035156 15.609375 14.027344 15.910156 14.78125 15.910156 C 15.199219 15.910156 15.828125 15.789063 16.667969 15.546875 C 17.507813 15.304688 17.925781 15.042969 17.925781 14.761719 C 17.925781 14.585938 17.8125 14.5 17.585938 14.5 C 17.234375 14.5 16.730469 14.546875 16.070313 14.640625 C 15.414063 14.734375 14.910156 14.78125 14.558594 14.78125 C 14.195313 14.78125 13.796875 14.6875 13.359375 14.5 C 12.921875 14.3125 12.703125 14.054688 12.703125 13.734375 C 12.703125 13.667969 12.714844 13.617188 12.734375 13.582031 C 12.753906 13.550781 12.785156 13.527344 12.824219 13.523438 C 12.867188 13.515625 12.90625 13.515625 12.945313 13.523438 C 12.988281 13.53125 13.039063 13.535156 13.109375 13.542969 C 13.175781 13.550781 13.234375 13.554688 13.289063 13.554688 C 13.410156 13.554688 13.585938 13.570313 13.8125 13.601563 C 14.039063 13.636719 14.210938 13.652344 14.316406 13.652344 C 14.734375 13.652344 15.585938 13.40625 16.878906 12.917969 C 18.167969 12.425781 18.8125 12.046875 18.8125 11.777344 C 18.8125 11.617188 18.6875 11.503906 18.4375 11.433594 C 18.191406 11.367188 17.957031 11.335938 17.742188 11.335938 C 17.554688 11.335938 17.273438 11.382813 16.894531 11.484375 C 16.519531 11.585938 16.109375 11.707031 15.664063 11.847656 C 15.222656 11.988281 14.925781 12.078125 14.777344 12.121094 C 14.832031 11.851563 14.859375 11.636719 14.859375 11.476563 C 14.859375 10.84375 14.691406 10.105469 14.355469 9.265625 C 14.019531 8.425781 13.628906 7.804688 13.1875 7.402344 C 12.824219 7.078125 12.339844 6.859375 11.734375 6.738281 C 11.359375 6.253906 10.769531 5.8125 9.972656 5.414063 C 9.171875 5.019531 8.460938 4.820313 7.84375 4.820313 C 7.722656 4.820313 7.539063 4.84375 7.289063 4.890625 C 7.042969 4.9375 6.886719 4.96875 6.820313 4.984375 L 6.375 5.609375 L 6.496094 5.628906 C 6.589844 5.628906 6.734375 5.617188 6.929688 5.589844 C 7.125 5.5625 7.269531 5.550781 7.363281 5.550781 C 7.820313 5.550781 8.34375 5.644531 8.933594 5.832031 C 8.558594 6.019531 8.230469 6.148438 7.949219 6.214844 C 7.921875 6.226563 7.835938 6.242188 7.6875 6.265625 C 7.539063 6.285156 7.414063 6.304688 7.3125 6.324219 C 7.210938 6.34375 7.117188 6.382813 7.03125 6.445313 C 6.945313 6.503906 6.898438 6.582031 6.898438 6.675781 C 7.652344 6.597656 8.21875 6.554688 8.59375 6.554688 C 9.105469 6.554688 9.507813 6.601563 9.804688 6.695313 C 8.765625 6.820313 7.972656 7.175781 7.414063 7.765625 C 6.855469 8.355469 6.574219 9.171875 6.574219 10.207031 C 6.574219 10.570313 6.601563 10.90625 6.65625 11.214844 C 6.910156 12.828125 7.402344 15.234375 8.128906 18.433594 C 8.574219 20.503906 8.820313 21.644531 8.875 21.859375 L 8.894531 21.941406 C 6.742188 21.269531 5.058594 20.019531 3.835938 18.199219 C 2.613281 16.378906 2 14.3125 2 12 Z M 7.707031 9.5 C 7.707031 9.582031 7.726563 9.660156 7.765625 9.742188 C 7.753906 9.527344 7.875 9.339844 8.128906 9.175781 C 8.382813 9.015625 8.625 8.933594 8.855469 8.933594 C 8.964844 8.933594 9.097656 8.96875 9.257813 9.035156 C 9.125 8.863281 8.929688 8.773438 8.671875 8.773438 C 8.445313 8.773438 8.226563 8.839844 8.019531 8.964844 C 7.808594 9.09375 7.707031 9.273438 7.707031 9.5 Z M 8.371094 11.011719 C 8.371094 10.835938 8.441406 10.679688 8.582031 10.539063 C 8.722656 10.398438 8.882813 10.324219 9.058594 10.324219 C 9.230469 10.324219 9.390625 10.398438 9.53125 10.539063 C 9.671875 10.679688 9.742188 10.835938 9.742188 11.011719 C 9.742188 11.1875 9.671875 11.34375 9.53125 11.484375 C 9.390625 11.628906 9.230469 11.699219 9.058594 11.699219 C 8.882813 11.699219 8.722656 11.628906 8.582031 11.484375 C 8.441406 11.34375 8.371094 11.1875 8.371094 11.011719 Z M 9.175781 10.789063 C 9.175781 10.898438 9.238281 10.949219 9.359375 10.949219 C 9.480469 10.949219 9.539063 10.898438 9.539063 10.789063 C 9.539063 10.667969 9.480469 10.609375 9.359375 10.609375 C 9.238281 10.609375 9.175781 10.667969 9.175781 10.789063 Z M 12.566406 9.035156 C 12.671875 8.859375 12.921875 8.773438 13.3125 8.773438 C 13.484375 8.773438 13.707031 8.839844 13.976563 8.976563 C 13.84375 8.679688 13.605469 8.53125 13.269531 8.53125 C 12.851563 8.53125 12.617188 8.699219 12.566406 9.035156 Z M 13.027344 10.609375 C 13.027344 10.449219 13.089844 10.308594 13.210938 10.195313 C 13.328125 10.082031 13.464844 10.023438 13.613281 10.023438 C 13.773438 10.023438 13.910156 10.082031 14.023438 10.195313 C 14.140625 10.308594 14.195313 10.449219 14.195313 10.609375 C 14.195313 10.757813 14.140625 10.890625 14.023438 11.011719 C 13.910156 11.132813 13.773438 11.191406 13.613281 11.191406 C 13.464844 11.191406 13.328125 11.132813 13.210938 11.011719 C 13.089844 10.890625 13.027344 10.757813 13.027344 10.609375 Z M 13.734375 10.40625 C 13.734375 10.515625 13.78125 10.566406 13.875 10.566406 C 13.984375 10.566406 14.035156 10.515625 14.035156 10.40625 C 14.035156 10.3125 13.980469 10.265625 13.875 10.265625 C 13.78125 10.265625 13.734375 10.3125 13.734375 10.40625 Z"></path>
      </svg>
    ),
  },
  brave: {
    name: "Brave",
    url: "https://search.brave.com/search",
    Icon: (props) => (
      <svg
        {...props}
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        width="24"
        height="24"
        fill="currentColor"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 50 50"
          width="24px"
          height="24px"
        >
          <path d="M46,11l-2.96-3.96c-1.22-1.22-3.08-1.52-4.62-0.75L37,7l-5-5H18l-5,5l-1.42-0.71c-1.54-0.77-3.4-0.47-4.62,0.75L4,11l2,3	l-2,4l5.77,17.47c0.79,2.28,2.38,4.19,4.47,5.38L25,47l10.76-6.15c2.09-1.19,3.68-3.1,4.47-5.38L46,18l-2-4L46,11z M25,40l-6-6	c0,0,5-3,6-3s6,3,6,3L25,40z M38.68,18.76L34,25l0.57,0.85c0.41,0.61,0.61,1.32,0.61,2.02c0,0.78-0.24,1.55-0.73,2.19	c-0.52,0.7-1.29,1.26-2.04,1.59C31.9,31.88,31.4,32,31,32c-0.9,0-2.617-1.621-5-3.331v-1.102l4.515-2.709	c0.369-0.221,0.555-0.654,0.462-1.074l-1.459-6.566c0.174-0.406,0.444-0.744,0.845-0.964L36,14l-3-1h-2l-0.014,0.014	c-0.1,0.002-0.202,0.004-0.303,0.038l-3,1c-0.486,0.162-0.771,0.666-0.66,1.166l1.844,8.296L25,25.834l-3.868-2.321l1.844-8.296	c0.111-0.5-0.174-1.003-0.66-1.166l-3-1c-0.101-0.034-0.202-0.036-0.303-0.038L19,13h-2l-3,1l5.638,2.253	c0.401,0.22,0.671,0.558,0.845,0.964l-1.459,6.566c-0.093,0.42,0.092,0.853,0.461,1.074L24,27.566v1.126	C21.553,30.436,19.884,32,19,32c-0.4,0-0.9-0.12-1.41-0.35c-0.75-0.33-1.52-0.89-2.04-1.59c-0.93-1.23-0.98-2.92-0.12-4.21L16,25	l-4.68-6.24c-0.79-1.05-0.8-2.48-0.04-3.55L15,9l2.73,0.55c0.38,0.08,0.77,0.11,1.16,0.11c1.08,0,2.16-0.29,3.1-0.85	c0.93-0.56,1.97-0.84,3.01-0.84s2.08,0.28,3.01,0.84c1.28,0.76,2.8,1.03,4.26,0.74L35,9l3.72,6.21	C39.48,16.28,39.47,17.71,38.68,18.76z" />
        </svg>
      </svg>
    ),
  },
}

const engineKeys = Object.keys(engines)

export function SearchBar({ initialEngine }: SearchBarProps) {
  const [searchQuery, setSearchQuery] = useState("")
  const [engineKey, setEngineKey] = useState(
    engineKeys.includes(initialEngine) ? initialEngine : "google"
  )
  const [isPending, startTransition] = useTransition()

  const handleSearch = (event: React.FormEvent<HTMLFormElement>) => {
    event.preventDefault()
    if (!searchQuery.trim()) return

    const baseUrl = engines[engineKey].url
    const params = new URLSearchParams({ q: searchQuery })
    const searchUrl = `${baseUrl}?${params.toString()}`

    window.location.href = searchUrl
    setSearchQuery("")
  }

  const handleEngineChange = (newEngine: string) => {
    if (!engineKeys.includes(newEngine)) return
    setEngineKey(newEngine)
    startTransition(async () => {
      await updateSearchEngine(newEngine)
    })
  }

  return (
    <div className="w-full max-w-lg">
      <form onSubmit={handleSearch} className="relative flex items-center">
        <Input
          type="search"
          placeholder="Search the web..."
          value={searchQuery}
          onChange={(e) => setSearchQuery(e.target.value)}
          className="h-12 rounded-full border-border bg-secondary/50 pl-5 pr-14 text-base backdrop-blur-sm transition-colors focus:bg-secondary"
        />

        <ContextMenu>
          <ContextMenuTrigger asChild>
            <Button
              type="submit"
              size="icon"
              className="absolute right-2 top-1/2 z-10 h-9 w-9 -translate-y-1/2 rounded-full"
            >
              <Search className="h-5 w-5" />
            </Button>
          </ContextMenuTrigger>
          <ContextMenuContent className="w-48 bg-popover">
            <ContextMenuRadioGroup
              value={engineKey}
              onValueChange={handleEngineChange}
            >
              {engineKeys.map((key) => {
                const engine = engines[key]
                return (
                  <ContextMenuRadioItem
                    key={key}
                    value={key}
                    className="flex cursor-pointer gap-2"
                    disabled={isPending}
                  >
                    <engine.Icon className="h-4 w-4 text-muted-foreground" />
                    <span>{engine.name}</span>
                  </ContextMenuRadioItem>
                )
              })}
            </ContextMenuRadioGroup>
          </ContextMenuContent>
        </ContextMenu>
      </form>
    </div>
  )
}
